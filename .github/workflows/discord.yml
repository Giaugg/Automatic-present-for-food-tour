name: Discord Notify

on:
  push:
  pull_request:
    types: [opened, closed]
  issue_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          EVENT="${{ github.event_name }}"
          ACTOR="${{ github.actor }}"

          if [[ "$EVENT" == "push" ]]; then
            MSG="üöÄ **Push** by $ACTOR to \`${{ github.ref_name }}\`"
          fi

          if [[ "$EVENT" == "pull_request" ]]; then
            TITLE="${{ github.event.pull_request.title }}"
            ACTION="${{ github.event.action }}"

            if [[ "$ACTION" == "opened" ]]; then
              MSG="üì¢ **PR Opened**: $TITLE by $ACTOR"
            elif [[ "$ACTION" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
              MSG="‚úÖ **PR Merged**: $TITLE"
            else
              MSG="‚ùå **PR Closed** (not merged): $TITLE"
            fi
          fi

          if [[ "$EVENT" == "issue_comment" ]]; then
            COMMENT="${{ github.event.comment.body }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"

            if [[ "${{ github.event.issue.pull_request }}" != "" ]]; then
              MSG="üí¨ **New PR Comment** by $ACTOR on **$ISSUE_TITLE**:\n$COMMENT"
            else
              MSG="üí¨ **New Issue Comment** by $ACTOR on **$ISSUE_TITLE**:\n$COMMENT"
            fi
          fi

          curl -H "Content-Type: application/json" \
          -d "{\"content\": \"$MSG\"}" \
          $DISCORD_WEBHOOK
